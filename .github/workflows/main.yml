#------------------------
# GitHub Actions
#------------------------

name: GitHub-Actions-Tests
env:
  APP_NAME: "Cryptocurrency Info"
  DEPLOY_PACKAGE_NAME: "deploy-ver-${{ github.sha }}"

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  client_tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: Run tests on client
      run : npm run test
  server_tests: 
    runs-on: ubuntu-latest
    needs: [client_tests]
    defaults:
      run:
        working-directory: ./server
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: Run tests on server
      run : npm run test
  cypress_tests:
    runs-on: ubuntu-22.04
    needs: [server_tests]
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    - name: Run server
      run : |
        cd server
        sudo rm -rf node_modules package-lock.json && npm install
        npm start &
        sleep 10 &&
        curl http://localhost:4000
    - name: Run client
      run : |
        cd client
        sudo rm -rf node_modules && rm package-lock.json && npm install
        npm start &
        sleep 10 &&
        curl http://localhost:3000
    - name: Run Cypress
      run : |
        cd client
        npx cypress run
    - uses: actions/upload-artifact@v3
      if: failure()
      with: 
        name: cypress-snapshots
        path: cypress/snapshots
